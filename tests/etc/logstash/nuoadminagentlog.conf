input {
  file {
    path => "/var/log/nuodb/agent.log"
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601} "
      auto_flush_interval => 5
      negate => true
      what => "previous"
    }
 }
}

filter {
  grok {
    match => { "message" => [
      "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:loglevel} %{NOTSPACE:logger} %{NOTSPACE:thread} +%{GREEDYDATA:message}",
      "%{TIMESTAMP_ISO8601:timestamp} \[%{POSINT:engine_pid}\] +%{GREEDYDATA:message}",
      "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:loglevel} +%{GREEDYDATA:message}"
    ] }
    overwrite => [ "message" ]
  }

  if [logger] == "Environment.logEnv" {
    grok {
      match => { "message" => [
        "NuoDB %{WORD:directory} directory: %{GREEDYDATA:value}",
        "NuoAgent version: %{GREEDYDATA:version}",
	"Java: %{GREEDYDATA:java_version}",
	"Java VM: %{GREEDYDATA:java_vm}",
	"Java Runtime: %{GREEDYDATA:java_runtime}",
	"Java Home directory: %{GREEDYDATA:java_home}"
      ] }
    }
  }

  if [logger] == "LocalServer.logNewRole" {
    grok {
      match => { "message" => [ 
        "\[.*\] Converting to (?<action>LEADER) \(term=[0-9]+, index=[0-9]+\)( %{GREEDYDATA:comment})?",
        "\[.*\] Converting to (?<action>FOLLOWER) \(term=[0-9]+, index=[0-9]+\)( %{GREEDYDATA:comment})?",
        "\[.*\] Converting to (?<action>CANDIDATE) \(term=[0-9]+, index=[0-9]+\)"
      ] }
    }
  }

  if [logger] == "PropertiesContainerImpl.logProps" {
    grok {
      match => { "message" => "Property %{NOTSPACE:property}=%{GREEDYDATA:value}"
      }
    }
  }

  if [logger] == "URLPropertiesProvider.<init>" {
    grok {
      match => { "message" => ".*properties file: %{GREEDYDATA:propertyfile}"
      }
    }
  }

  if [logger] == "PeerContainerImpl$LocalPeer.initStableId" {
    grok {
      match => { "message" => "Initializing local peer.* uuid:%{UUID:stableid}"
      }
    }
  }

  if [logger] == "PeerContainerImpl$LocalPeer.<init>" {
    grok {
      match => { "message" => "local bind address=%{IPORHOST:bindhost}?/%{IPORHOST:bindaddr}?:%{POSINT:bindport}, hostname=%{IPORHOST:bhostname}"
      }
    }
  }

  if [logger] == "PeerService$EntryListener.handleMessage" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => [
        "Peering reply from \[%{IPORHOST:peerhost}?/%{IPORHOST:peeraddr}?:%{POSINT:peerport}, uuid:%{UUID:stableid}\] \(%{NUODB_AGENTTYPE:peertype}\)",
	"License Allowed Hosts: %{POSINT}"
      ] }
    }
  }

  if [logger] == "TagServer$DomainJoinedRunnable.run" {
    grok {
      match => { "message" => "Region is: %{GREEDYDATA:region}"
      }
    }
  }

  if [logger] == "EventManager.notifyPeerEvent" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action}: \[%{NUODB_PEER:peer_description}\]"
      }
    }
  }

  if [logger] == "EventManager.notifyDomainEvent" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{NUODB_ACTIONS:action} %{NUODB_ENTITY:entity}"
      }
    }
  }

  if [logger] == "EventManager.notifyNodeEvent" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action}%{GREEDYDATA:comment}?: %{NUODB_NODE:node_description}"
      }
    }
  }

  if [logger] == "EventManager.notifyNodeIdSet" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action}=%{POSINT:newnodeid} %{NUODB_NODE:node_description}"
      }
    }
  }

  if [logger] == "EventManager.notifyNodeStateChange" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action} changed to %{WORD:node_state} %{NUODB_NODE:node_description}"
      }
    }
  }

  if [logger] == "EventManager.notifyNodeFailure" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => [
        "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action} peer=\[%{NUODB_PEER}\] startId=\[%{NUMBER:startId}\]:%{NUODB_GREEDYDATA:comment}",
        "%{NUODB_ENTITY:entity} %{NUODB_ACTIONS:action} %{NUODB_NODE:node_description}: %{NUODB_GREEDYDATA:comment}"
      ] }
    }
  }

  if [logger] == "ProcessService$ProcessReaper.reapConnected" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{WORD:action} process with pid %{NUODB_PID:node_pid} and exit code %{NUMBER:exitcode}"
      }
    }
  }

  if [logger] == "ProcessService.nodeLeft" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => [
        "%{WORD:action} up pid.%{NUMBER:node_pid} with exit code.%{NUMBER:exitcode}",
        "Marking process with %{NUODB_ENTITY:entity} object %{NUODB_NODE:node_description} for %{NUODB_ACTIONS:action}"
      ] }
    }
  }

  if [logger] == "NuoAgent.logReady" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{GREEDYDATA:comment}; agent is ready"
      }
    }
  }

  if [logger] == "NuoAgent.shutdown" {
    grok {
      patterns_dir => ["./nuodb_patterns"]
      match => { "message" => "%{GREEDYDATA:comment}"
      }
    }
  }

}

output {
  stdout { codec => json_lines }
}
